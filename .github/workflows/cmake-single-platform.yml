name: CMake on a single platform

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:noble
      options: --user root

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          # 配置完整源（包含所有必要组件）
          cat > /etc/apt/sources.list <<EOF
          deb http://archive.ubuntu.com/ubuntu noble main universe restricted multiverse
          deb http://archive.ubuntu.com/ubuntu noble-updates main universe restricted multiverse
          deb http://archive.ubuntu.com/ubuntu noble-security main universe restricted multiverse
          EOF

          # 强制更新源并忽略警告
          apt update -y -qq > /dev/null

          # 安装依赖（修正g+为g++）
          apt install -y -qq \
            libmariadb-dev \
            libhiredis-dev \
            libssl-dev \
            zlib1g-dev \
            cmake \
            g++ \
            make > /dev/null

          # 创建MySQL兼容链接
          ln -sf /usr/lib/x86_64-linux-gnu/libmariadb.so /usr/lib/x86_64-linux-gnu/libmysqlclient.so
          ln -sf /usr/include/mariadb/ /usr/include/mysql

          # 验证安装
          if ! command -v g++ &> /dev/null; then
            echo "g++未安装" && exit 1
          fi
          if ! command -v cmake &> /dev/null; then
            echo "cmake未安装" && exit 1
          fi
          if [ ! -f "/usr/lib/x86_64-linux-gnu/libmysqlclient.so" ]; then
            echo "MySQL链接失败" && exit 1
          fi
          if [ ! -f "/usr/include/mysql/mysql.h" ]; then
            echo "MariaDB头文件缺失" && exit 1
          fi

      - name: Configure CMake
        run: |
          cmake -B ${{ github.workspace }}/build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_COMPILER=g++

      - name: Build
        run: |
          cmake --build ${{ github.workspace }}/build \
            --config ${{ env.BUILD_TYPE }} \
            --parallel $(nproc)

      - name: Test
        working-directory: ${{ github.workspace }}/build
        run: |
          if [ -f "CTestTestfile.cmake" ]; then
            ctest -C ${{ env.BUILD_TYPE }} --output-on-failure
          else
            echo "无测试用例，跳过测试"
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ${{ github.workspace }}/build/CMakeFiles/CMakeError.log