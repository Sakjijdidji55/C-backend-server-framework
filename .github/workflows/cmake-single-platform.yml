name: CMake on a single platform

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:noble
      options: --user root

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          # 彻底清理冲突的源配置
          rm -f /etc/apt/sources.list
          rm -f /etc/apt/sources.list.d/*.list
          rm -f /etc/apt/sources.list.d/*.sources

          # 重新配置唯一源
          cat > /etc/apt/sources.list <<EOF
          deb http://archive.ubuntu.com/ubuntu noble main universe restricted multiverse
          deb http://archive.ubuntu.com/ubuntu noble-updates main universe restricted multiverse
          deb http://archive.ubuntu.com/ubuntu noble-security main universe restricted multiverse
          EOF

          # 更新源并安装依赖（显式指定所有包，确保无拼写错误）
          apt update -y
          apt install -y \
            libmariadb-dev \
            libhiredis-dev \
            libssl-dev \
            zlib1g-dev \
            cmake \
            g++ \
            make \
            apt-utils  # 解决debconf警告

          # 创建MySQL兼容链接
          if [ -f "/usr/lib/x86_64-linux-gnu/libmariadb.so" ]; then
            ln -sf /usr/lib/x86_64-linux-gnu/libmariadb.so /usr/lib/x86_64-linux-gnu/libmysqlclient.so
          else
            echo "错误：MariaDB库文件不存在" && exit 1
          fi

          if [ -d "/usr/include/mariadb" ]; then
            ln -sf /usr/include/mariadb/ /usr/include/mysql
          else
            echo "错误：MariaDB头文件目录不存在" && exit 1
          fi

          # 改进验证逻辑（直接检查命令版本）
          echo "=== 验证依赖版本 ==="
          if ! g++ --version >/dev/null 2>&1; then
            echo "错误：g++未安装" && exit 1
          fi
          if ! cmake --version >/dev/null 2>&1; then
            echo "错误：cmake未安装" && exit 1
          fi
          if ! make --version >/dev/null 2>&1; then
            echo "错误：make未安装" && exit 1
          fi
          
          echo "=== 验证MySQL/MariaDB ==="
          if [ ! -L "/usr/lib/x86_64-linux-gnu/libmysqlclient.so" ]; then
            echo "错误：MySQL链接失败" && exit 1
          fi
          if [ ! -f "/usr/include/mysql/mysql.h" ]; then
            echo "错误：MariaDB头文件缺失" && exit 1
          fi
          
          echo "=== 验证Redis ==="
          if [ ! -f "/usr/lib/x86_64-linux-gnu/libhiredis.so" ]; then
            echo "错误：Redis库失败" && exit 1
          fi
          if [ ! -f "/usr/include/hiredis/hiredis.h" ]; then
            echo "错误：Redis头文件无效" && exit 1
          fi

      - name: Configure CMake
        run: |
          cmake -B ${{ github.workspace }}/build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_COMPILER=g++

      - name: Build
        run: |
          cmake --build ${{ github.workspace }}/build \
            --config ${{ env.BUILD_TYPE }} \
            --parallel $(nproc)

      - name: Test
        run: |
          # 明确使用工作区变量定位 build 目录
          BUILD_DIR="${{ github.workspace }}/build"
          echo "检查 build 目录: $BUILD_DIR"

          # 验证目录存在性
          if [ ! -d "$BUILD_DIR" ]; then
            echo "错误：build 目录不存在 - $BUILD_DIR"
            exit 1
          fi

          # 进入 build 目录执行测试
          cd "$BUILD_DIR" || {
            echo "错误：无法进入 build 目录 - $BUILD_DIR"
            exit 1
          }

          # 执行测试（如果测试文件存在）
          if [ -f "CTestTestfile.cmake" ]; then
            ctest -C ${{ env.BUILD_TYPE }} --output-on-failure
          else
            echo "无测试用例，跳过测试"
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ${{ github.workspace }}/build/CMakeFiles/CMakeError.log
            ${{ github.workspace }}/build/CMakeFiles/CMakeOutput.log