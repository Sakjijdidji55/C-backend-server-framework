name: CMake on a single platform

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 修复1：添加Redis依赖 + 安全优化 + 幂等软链接
      - name: Install system dependencies (MariaDB + Redis)
        run: |
          # 清理缓存并更新源（避免包索引过期）
          sudo apt clean
          sudo apt update -y
          
          # 安装依赖（移除不安全的--allow-unauthenticated，添加Redis库）
          sudo apt install -y \
            libmariadb-dev \          # MariaDB客户端（兼容MySQL）
            libhiredis-dev \          # Redis客户端开发库（核心新增）
            libssl-dev \              # OpenSSL依赖
            zlib1g-dev \              # Zlib依赖
            cmake \
            g++ \
            make
          
          # 修复2：幂等创建软链接（-f强制覆盖，避免"文件已存在"错误）
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libmariadb.so /usr/lib/x86_64-linux-gnu/libmysqlclient.so
          sudo ln -sf /usr/include/mariadb/ /usr/include/mysql
          
          # 验证关键依赖是否存在
          echo "=== 验证MySQL/MariaDB链接 ==="
          ls -l /usr/lib/x86_64-linux-gnu/libmysqlclient.so || { echo "MySQL库链接失败"; exit 1; }
          ls -l /usr/include/mysql/mysql.h || { echo "MySQL头文件缺失"; exit 1; }
          
          echo "=== 验证Redis依赖 ==="
          ls -l /usr/lib/x86_64-linux-gnu/libhiredis.so || { echo "Redis库缺失"; exit 1; }
          ls -l /usr/include/hiredis/hiredis.h || { echo "Redis头文件缺失"; exit 1; }

      # 修复3：输出CMake详细配置日志，便于排查依赖问题
      - name: Configure CMake
        run: |
          cmake -B ${{github.workspace}}/build \
            -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
            --log-level=VERBOSE 2>&1 | tee cmake_config.log

      # 修复4：输出编译详细日志，快速定位错误
      - name: Build
        run: |
          cmake --build ${{github.workspace}}/build \
            --config ${{env.BUILD_TYPE}} \
            --parallel 4 \
            --verbose 2>&1 | tee build.log
          # 若编译失败，打印最后100行日志
          if [ $? -ne 0 ]; then
            echo -e "\n=== 编译失败，关键错误信息 ==="
            tail -n 100 build.log
            exit 1
          fi

      - name: Test
        working-directory: ${{github.workspace}}/build
        run: ctest -C ${{env.BUILD_TYPE}} || echo "Tests skipped (no tests defined)"

      # 修复5：构建失败时上传日志，方便排查
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ${{github.workspace}}/cmake_config.log
            ${{github.workspace}}/build.log
            ${{github.workspace}}/build/CMakeFiles/CMakeError.log